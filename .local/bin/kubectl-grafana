#!/usr/bin/env bash

# The following script updates all kubeconfig files, which were generated using
# the grafana-kubernetes-plugin
# (https://github.com/ricoberger/grafana-kubernetes-plugin). It will go through
# all files in the ~/Documents/kubeconfig/ directory, which start with
# "kubeconfig-" and will update the kubeconfig file with a fresh one from the
# Grafana API.

set -e

for f in `fd --full-path --hidden --color never --type f -e yaml "kubeconfig-" "${HOME}/Documents/kubeconfig/"`; do
  cluster=`yq e '.clusters[0].cluster.server' < "${f}"`
  cluster=${cluster%api*}
  echo "Cluster: ${cluster}"

  args=`yq e '.users[0].user.exec.args[1]' < "${f}"`
  token=`bash -c "$args" | jq -r '.status.token'`

  kubeconfig=`curl -H "Authorization: Bearer ${token}" "${cluster}api/datasources/uid/kubernetes/resources/kubernetes/kubeconfig" | yq e -P '.' -`
  echo "${kubeconfig}" > ${f}
done
